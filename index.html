<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Sendgrid Template Transfer : Ruby script to transfer Sendgrid templates from one account to another, using the Sendgrid Template API.">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Sendgrid Template Transfer</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/astrocaribe/template_transfer">View on GitHub</a>

          <h1 id="project_title">Sendgrid Template Transfer</h1>
          <h2 id="project_tagline">Ruby script to transfer Sendgrid templates from one account to another, using the Sendgrid Template API.</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/astrocaribe/template_transfer/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/astrocaribe/template_transfer/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a id="templatetransferscript" class="anchor" href="#templatetransferscript" aria-hidden="true"><span class="octicon octicon-link"></span></a>TemplateTransfer::Script</h1>

<h2>
<a id="scope" class="anchor" href="#scope" aria-hidden="true"><span class="octicon octicon-link"></span></a>Scope</h2>

<p>The purpose of this script is tranfer Sendgrid templates and their versions from one account to another.</p>

<p>Currently, Sendgrid does not the option for automatic bulk tranfer of templates; to accomplish this task, templates have to be manually copied from one account, and saved to the other. This script automatates this task, using the available Sendgrid template API (<a href="https://sendgrid.com/docs/API_Reference/Web_API_v3/Template_Engine/templates.html">https://sendgrid.com/docs/API_Reference/Web_API_v3/Template_Engine/templates.html</a>).</p>

<h2>
<a id="setup" class="anchor" href="#setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setup</h2>

<p>It is recommended to configre an RVM gemset:</p>

<pre><code>$&gt; echo 'ruby-2.1.2' &gt; .ruby-version
$&gt; echo 'template_tranfer' &gt; .ruby-gemset
</code></pre>

<p>Note: The <code>$&gt;</code> is meant to signify the terminal prompt, and is not part of the command; do not include this prompt in your command line!</p>

<p>Install bundled gems:</p>

<pre><code>$&gt; bundle install
</code></pre>

<p>Note: This script is bundled as a gem; there are no other dependencies except the ones bundled with this gem (available via <a href="http://rubygems.com">http://rubygems.com</a>).</p>

<h2>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuration</h2>

<p>This project expects a local config/config.yml to specify the following:</p>

<ol>
<li>
<strong>sendgrid:</strong> Sendgrid credentials for accounts to transfer templates <em>from</em> and <em>to</em>, in that order.</li>
<li>
<strong>prepend_name:</strong> String text to prepend to the beginning of each template name, to help distiguish tranffered templates.</li>
<li>
<strong>endpoint:</strong> URI endpoint for the Sendgrid template API operations.</li>
</ol>

<p>An example file has been supplied and the primary file is ignored by version control:</p>

<pre><code>$&gt; cp config/config.yml.example config/config.yml
</code></pre>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span class="octicon octicon-link"></span></a>Usage</h2>

<p>The script can be run directly from the <em>bin/</em> directory; first, make the script launcher executable, if it isn't already:</p>

<pre><code>$&gt; chmod +x bin/template_transfer
</code></pre>

<p>Then execute the script:</p>

<pre><code>$&gt; bin/template_transfer
</code></pre>

<p>You can also time the script operation to determine how long the transfer takes:</p>

<pre><code>$&gt; time bin/template_transfer
</code></pre>

<h2>
<a id="templatetransferscript-flow" class="anchor" href="#templatetransferscript-flow" aria-hidden="true"><span class="octicon octicon-link"></span></a>TemplateTransfer::Script Flow</h2>

<p>This script was born out of the lack of resources to transfer templates between accounts, using the supplied Sendgrid Template API (<a href="https://sendgrid.com/docs/API_Reference/Web_API_v3/Template_Engine/templates.html">https://sendgrid.com/docs/API_Reference/Web_API_v3/Template_Engine/templates.html</a>). Below is an outline of the process I used to accomplish the task. Most of this was trial and error, and I want to save others the pain of this process.</p>

<p>Note that this solution was coded in Ruby 2.1.2; to code in another language, just use this flow and code against appropriate analogs. I may code this solution in Python as well, if there is demand.</p>

<p><strong>Important Caveat:</strong> This script <strong>does not</strong> selectively copy templates, nor is there the ability to select the templates that you want tranffered. This script will copy <strong>ALL</strong> templates from the first account!</p>

<h3>
<a id="tranfer-steps" class="anchor" href="#tranfer-steps" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tranfer Steps</h3>

<ol>
<li>
<p>Copy all templates from Account1 (account you want to copy templates from):</p>

<ul>
<li>This operation does not copy the template contents, though identifying metadata for templates and underlying versions (id, name, etc.) are returned.</li>
<li>The :name and :id of each template is stored in an array in memory for use in the following steps.</li>
<li>Curl Example: <code>curl -X GET https://username:password@api.sendgrid.com/v3/templates/</code>
</li>
</ul>
</li>
<li>
<p>Retrieve each template, with given :id from step 1:</p>

<ul>
<li>This operation retrieve one template, but returns all relevant data for that template (:name, :id, :versions, :html_content, :plain_content, etc.)</li>
<li>Returns the retrieved template.</li>
<li>Cur Example: <code>curl -X GET https://username:password@api.sendgrid.com/v3/templates/:template_id</code>
</li>
</ul>
</li>
<li>
<p>Backup template:</p>

<ul>
<li>This step stores this template in a JSON file in the templates/ directory</li>
<li>Name format is ':template_id'.json</li>
</ul>
</li>
<li>
<p>Create an empty template in Account2 (receiving account):</p>

<ul>
<li>Before any template information can be tranffered, a new template needs to be created.</li>
<li>A name is required to create the new template. The name of the original template, with a prepended string is used in the script.</li>
<li>The newly created template will have a different :id than the original</li>
<li>
<strong>Note:</strong> If a template with the name that already exist is attempted, the creation will fail.</li>
<li>Curl Example <code>curl -H "Content-Type: application/json" -X POST -d {"name":"template_name"} https://username:password@api.sendgrid.com/v3/templates/</code>
</li>
</ul>
</li>
<li>
<p>Populate template:</p>

<ul>
<li>Tranfer the template information retrieved in step 2.</li>
<li>Script pushes versions of current template, one at a time, if different versions exist.</li>
<li>Relevant template version documentation can be found at <a href="https://sendgrid.com/docs/API_Reference/Web_API_v3/Template_Engine/versions.html">https://sendgrid.com/docs/API_Reference/Web_API_v3/Template_Engine/versions.html</a>
</li>
<li>Curl Example <code>curl -H "Content-Type: application/json" -X POST -d @template_content.json https://username:password@api.sendgrid.com/v3/templates/:template_id/versions</code>
</li>
</ul>
</li>
<li>
<p>Repeat steps #2-#5 until the end of the array returned in step #1</p>

<ul>
<li>Perform Steps #2 thru #5 for all templates in the array.</li>
</ul>
</li>
</ol>

<hr>

<h1>
<a id="notes" class="anchor" href="#notes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Notes</h1>

<h3>
<a id="may-18-2015" class="anchor" href="#may-18-2015" aria-hidden="true"><span class="octicon octicon-link"></span></a>May 18, 2015</h3>

<hr>

<ol>
<li>Retrieving all templates from a given account DOES NOT return template content. As such, the following approach will be taken:

<ul>
<li>Retrieve all template information, and build an array of main template ids.</li>
<li>Iterate through array to retrieve/store content for each template (including versions).</li>
</ul>
</li>
</ol>

<h3>
<a id="may-19-2015" class="anchor" href="#may-19-2015" aria-hidden="true"><span class="octicon octicon-link"></span></a>May 19, 2015</h3>

<hr>

<ol>
<li>Based on experience from last coding session, script now follows these steps:

<ul>
<li>Retrieves all templates from account, storing :id and :name in an template array of hashes.</li>
<li>Iterates over template array, retrieving by template id, then storing each retrieved template in an external file (template_id.json), including metadata (versions, html_content, plain_content, for example).</li>
</ul>
</li>
</ol>

<h3>
<a id="may-20-2015" class="anchor" href="#may-20-2015" aria-hidden="true"><span class="octicon octicon-link"></span></a>May 20, 2015</h3>

<hr>

<ol>
<li>Changed #save_template to #backup_template. Since the downloaded template will already be in memory, it makes more sense to backup the template for prosperity's sake, then create and populate a new template with the current template in memory. No need to read a file for this operation!</li>
<li>Include the 2nd account (secondary_account?) to config.yml file. This will be needed for creating and populating the new templates.</li>
</ol>

<h3>
<a id="may-21-2015" class="anchor" href="#may-21-2015" aria-hidden="true"><span class="octicon octicon-link"></span></a>May 21, 2015</h3>

<hr>

<ol>
<li>Script now creates a new template for every imported template.</li>
<li>Currently attempting to populate new templates with versions from the imported template.</li>
</ol>

<h4>
<a id="observations" class="anchor" href="#observations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Observations:</h4>

<ul>
<li>Version names must be unique accross accounts</li>
<li>If template already exists, 400 response is returned

<ul>
<li>I'm going to assume that all templates will be unique on the CHC site</li>
</ul>
</li>
<li>Current attempts at populating the newly created template results in a 400 error from Sendgrid:

<ul>
<li>Net::HTTPBadRequest 400 BAD REQUEST readbody=true</li>
<li>{"error"=&gt;"JSON is malformed"}</li>
</ul>
</li>
</ul>

<h3>
<a id="may-22-2015" class="anchor" href="#may-22-2015" aria-hidden="true"><span class="octicon octicon-link"></span></a>May 22, 2015</h3>

<hr>

<ol>
<li>Working proptotype script!</li>
<li>Template are now being tranffered, including versions.</li>
<li>The previous error was due to trying to process a versions array. The solution was to process each item in the array seperately.</li>
</ol>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Sendgrid Template Transfer maintained by <a href="https://github.com/astrocaribe">astrocaribe</a></p>
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
